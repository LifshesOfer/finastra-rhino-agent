# https://docs.microsoft.com/en-us/azure/devops/pipelines/build/variables?view=azure-devops&tabs=yaml

name: Rhino.Agent.$(Year:yyyy).$(Month).$(DayOfMonth)$(Rev:.r)

trigger:
  branches:
    include:
    - new-integration

pool:
  vmImage: windows-2022

variables:
- group: github.com
- group: browserstack.com
- group: gravity.api
- name: 'Build.Configuration'
  value: 'Release'
- name: 'Release.PreRelease'
  value: true
- name: 'Release.Prefix'
  value: 'Preview'
- name: 'Docker.Tags'
  value: |
    v$(buildVersion)-$(Release.Prefix)

stages:
  - stage: PublishDocker
    displayName: Publish on DockerHub
    #dependsOn: 'Test'
    #condition: 'succeeded()'
    jobs:
    - job: 'CraeteRelease'
      displayName: 'Create a Docker Release & Tag'
      steps:
      - task: Docker@2
        displayName: 'Logout from Docker'
        inputs:
          containerRegistry: 'docker.io'
          command: 'logout'

      - task: Docker@2
        displayName: 'Login to Docker'
        inputs:
          containerRegistry: 'docker.io'
          command: 'login'

      - task: PowerShell@2
        displayName: 'Parse Build Version'
        inputs:
          targetType: 'inline'
          script: |
            # setup
            [regex]$pattern = '(\d+.?)+'
            $version        = $pattern.Matches('$(Build.BuildNumber)') | foreach-object {$_.Value}
            # set value
            Write-Host "##vso[task.setvariable variable=buildVersion]$version"

      - task: PowerShell@2
        displayName: 'Format Docker Tags'
        inputs:
          targetType: 'inline'
          script: |
            $tags = '$(Docker.Tags)'.ToLower()
            Write-Host "##vso[task.setvariable variable=dockerTags]$tags"

      - task: Docker@2
        displayName: 'Create Docker Image - Linux'
        inputs:
          containerRegistry: 'docker.io'
          repository: 'rhinoapi/rhino-agent'
          command: 'buildAndPush'
          Dockerfile: '**/Dockerfile'
          tags: $(dockerTags)
